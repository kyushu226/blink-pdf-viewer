<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Face Scroll PDF Viewer</title>

<style>
body {
  margin: 0;
  background: #111;
  color: white;
  overflow: hidden;
  font-family: sans-serif;
}

#controls {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 10;
}

#tempoBox {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 220px;
  text-align: center;
}

#tempoDots {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.dot {
  width: 14px;
  height: 14px;
  background: #555;
  border-radius: 50%;
  transition: transform 0.1s, background 0.1s;
}

.active {
  background: #0f0;
  transform: scale(1.8);
}

canvas {
  display: block;
  margin: auto;
}
</style>
</head>

<body>

<div id="controls">
  <input type="file" id="pdfInput" accept="application/pdf">
  <button id="setCenter">この顔が正面</button>
</div>

<canvas id="pdfCanvas"></canvas>

<div id="tempoBox">
  <div id="tempoDots">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
  </div>
  <div>BPM: <span id="bpmValue">80</span></div>
  <input type="range" id="bpm" min="50" max="160" value="80">
  <br><br>
  <button id="startTempo">▶</button>
  <button id="stopTempo">■</button>
</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>

<script>
/* ===== PDF SETUP ===== */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const canvas = document.getElementById("pdfCanvas");
const ctx = canvas.getContext("2d");

document.getElementById("pdfInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  const url = URL.createObjectURL(file);
  const pdf = await pdfjsLib.getDocument(url).promise;

  let y = 0;
  const scale = 1.5;
  const pages = [];

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale });
    pages.push({ page, viewport });
  }

  canvas.width = pages[0].viewport.width;
  canvas.height = pages.reduce((s,p)=>s+p.viewport.height,0);

  for (const p of pages) {
    await p.page.render({
      canvasContext: ctx,
      viewport: p.viewport,
      transform: [1,0,0,1,0,y]
    }).promise;
    y += p.viewport.height;
  }
});

/* ===== TEMPO ===== */
let bpm = 80;
let beat = 0;
let timer = null;

const dots = document.querySelectorAll(".dot");
const bpmSlider = document.getElementById("bpm");
const bpmValue = document.getElementById("bpmValue");

bpmSlider.oninput = () => {
  bpm = bpmSlider.value;
  bpmValue.innerText = bpm;
  if (timer) restartTempo();
};

function tick() {
  dots.forEach(d => d.classList.remove("active"));
  dots[beat].classList.add("active");
  beat = (beat + 1) % 4;
}

function startTempo() {
  stopTempo();
  tick();
  timer = setInterval(tick, 60000 / bpm);
}

function stopTempo() {
  clearInterval(timer);
  timer = null;
}

function restartTempo() {
  if (timer) startTempo();
}

document.getElementById("startTempo").onclick = startTempo;
document.getElementById("stopTempo").onclick = stopTempo;

/* ===== FACE SCROLL ===== */
let baseY = null;
let scrollSpeed = 0;

const video = document.createElement("video");
video.style.display = "none";
document.body.appendChild(video);

const faceMesh = new FaceMesh({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
});

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true
});

faceMesh.onResults(r => {
  if (!r.multiFaceLandmarks) return;
  const y = r.multiFaceLandmarks[0][1].y;
  if (baseY === null) return;

  const diff = y - baseY;
  if (diff > 0.015) scrollSpeed = 3;
  else if (diff < -0.015) scrollSpeed = -3;
  else scrollSpeed = 0;
});

document.getElementById("setCenter").onclick = () => {
  baseY = null;
  alert("顔を正面に向けてください");
  setTimeout(() => baseY = lastY, 1500);
};

let lastY = null;

const cam = new Camera(video, {
  onFrame: async () => {
    await faceMesh.send({ image: video });
    if (scrollSpeed !== 0) window.scrollBy(0, scrollSpeed);
  },
  width: 640,
  height: 480
});

cam.start();
</script>

</body>
</html>
